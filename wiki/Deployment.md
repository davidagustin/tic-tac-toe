# Deployment Guide

Full documentation of the infrastructure, Docker production stack, CI/CD pipeline, and SSL setup for deploying the Tic-Tac-Toe Online server.

---

## Infrastructure (Terraform)

All infrastructure is defined in `infra/terraform/` using Terraform >= 1.5 with the AWS provider (~> 5.0).

### Resources

| Resource | Type | Description |
|----------|------|-------------|
| EC2 Instance | `t2.micro` | Free tier eligible. Amazon Linux 2023. 30GB gp3 root volume. |
| Elastic IP | `aws_eip` | Static public IP bound to the EC2 instance. |
| Security Group | `aws_security_group` | Inbound: SSH (22, restricted CIDR), HTTP (80), HTTPS (443). Outbound: all. |
| IAM Role | `aws_iam_role` | EC2 instance role for SSM parameter access. |
| IAM Instance Profile | `aws_iam_instance_profile` | Attached to EC2 instance. |
| SSM Parameters | Module `secrets` | All secrets stored in SSM Parameter Store (free tier). |

### Terraform Variables

| Variable | Type | Description |
|----------|------|-------------|
| `aws_region` | `string` | AWS region. Default: `us-west-2`. |
| `key_pair_name` | `string` | Name of your EC2 key pair for SSH access. |
| `ssh_allowed_cidr` | `list(string)` | CIDR blocks allowed to SSH (e.g., `["203.0.113.0/32"]`). |

### EC2 User Data

The instance bootstraps with:

```bash
#!/bin/bash
yum update -y
yum install -y docker git
systemctl start docker
systemctl enable docker
usermod -a -G docker ec2-user

# Install Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
  -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

---

## Secrets Management (SSM Parameter Store)

All secrets are generated by Terraform and stored in AWS SSM Parameter Store under the path `/ttt/prod/`.

### Parameters

| SSM Path | Type | Description |
|----------|------|-------------|
| `/ttt/prod/database/username` | String | PostgreSQL username (`ttt_user`) |
| `/ttt/prod/database/password` | SecureString | PostgreSQL password (32 chars, auto-generated) |
| `/ttt/prod/database/name` | String | Database name (`ttt_db`) |
| `/ttt/prod/database/url` | SecureString | Full PostgreSQL connection string |
| `/ttt/prod/redis/password` | SecureString | Redis password (32 chars, auto-generated) |
| `/ttt/prod/redis/url` | SecureString | Full Redis connection string |
| `/ttt/prod/jwt/access-secret` | SecureString | JWT access token secret (64 chars) |
| `/ttt/prod/jwt/refresh-secret` | SecureString | JWT refresh token secret (64 chars) |
| `/ttt/prod/app/node-env` | String | `production` |
| `/ttt/prod/app/port` | String | `3001` |
| `/ttt/prod/oauth/google-client-id` | SecureString | Google OAuth client ID (set manually) |
| `/ttt/prod/oauth/google-client-secret` | SecureString | Google OAuth client secret (set manually) |
| `/ttt/prod/oauth/google-callback-url` | String | Google OAuth redirect URI |

### IAM Policy

The EC2 instance role has a policy allowing:
- `ssm:GetParameter`, `ssm:GetParameters`, `ssm:GetParametersByPath` on `/ttt/prod/*`
- `kms:Decrypt` for SecureString parameters (via SSM service)

---

## Docker Production Stack

Defined in `docker-compose.prod.yml` at the project root.

### Services

| Service | Image | Port | Description |
|---------|-------|------|-------------|
| `app` | Built from `apps/server/Dockerfile` | 3001 (internal) | Node.js application server |
| `postgres` | `postgres:16-alpine` | 5432 (internal) | PostgreSQL database with persistent volume |
| `redis` | `redis:7-alpine` | 6379 (internal) | Redis with AOF persistence and password auth |
| `nginx` | Built from `nginx/Dockerfile` | 80, 443 | Reverse proxy, SSL termination, rate limiting |

### Volumes

| Volume | Mounted To | Purpose |
|--------|-----------|---------|
| `postgres_data` | `/var/lib/postgresql/data` | PostgreSQL data persistence |
| `redis_data` | `/data` | Redis AOF persistence |
| `certbot_webroot` | `/var/www/certbot` (read-only) | Let's Encrypt ACME challenge files |

### Service Dependencies

```
nginx --> app --> postgres (healthy)
               --> redis (healthy)
```

Both `postgres` and `redis` have health checks. The app container waits until both are healthy before starting.

### Health Checks

| Service | Command | Interval | Timeout | Retries |
|---------|---------|----------|---------|---------|
| PostgreSQL | `pg_isready -U ttt_user -d ttt_db` | 5s | 5s | 5 |
| Redis | `redis-cli -a $REDIS_PASSWORD ping` | 5s | 5s | 5 |

---

## Nginx Configuration

Nginx runs as the public-facing entry point.

### Features

| Feature | Configuration |
|---------|--------------|
| SSL termination | Let's Encrypt certificates |
| HTTP to HTTPS redirect | All port 80 traffic redirected to 443 |
| Reverse proxy | Proxies to app container on port 3001 |
| WebSocket proxy | Socket.IO path `/api/socket.io/` with upgrade headers |
| Rate limiting | 10 requests/second burst for API endpoints |
| ACME challenge | Exception path `/.well-known/acme-challenge/` for cert renewal |

### SSL Certificates

| File | Mount Path |
|------|-----------|
| `fullchain.pem` | `/etc/nginx/ssl/fullchain.pem` |
| `privkey.pem` | `/etc/nginx/ssl/privkey.pem` |

Host path: `/etc/letsencrypt/live/game-practice-aws.com/`

---

## CI/CD Pipeline (GitHub Actions)

Defined in `.github/workflows/ci.yml`. Triggered on push and pull requests to `main`.

### Pipeline Overview

```
push/PR to main
       |
       v
   [Test Job]
       |
       v
  [Build Job]
       |
       v (main branch push only)
  [Deploy Job]
```

### Test Job

Runs on `ubuntu-latest` with Node.js 20.

| Step | Command | Purpose |
|------|---------|---------|
| Install | `npm ci` | Install dependencies |
| Lint shared | `cd packages/shared && npx tsc --noEmit` | Type-check shared package |
| Test shared | `cd packages/shared && npx vitest run` | Run shared package tests |
| Build shared | `cd packages/shared && npx tsc` | Compile shared TypeScript |
| Prisma generate | `cd apps/server && npx prisma generate` | Generate Prisma client |
| Lint server | `cd apps/server && npx tsc --noEmit` | Type-check server |

### Build Job

Depends on: Test Job

| Step | Command | Purpose |
|------|---------|---------|
| Docker build | `docker build -f apps/server/Dockerfile -t ttt-server:test .` | Verify Docker image builds |

### Deploy Job

Depends on: Build Job. Only runs on pushes to `main` (not PRs).

| Step | Description |
|------|-------------|
| Configure AWS credentials | Uses `aws-actions/configure-aws-credentials@v4` with secrets |
| Login to ECR | Authenticates with Amazon ECR |
| Build + push image | Builds Docker image tagged with commit SHA, pushes to ECR |
| Get runner IP | Fetches the GitHub Actions runner's public IP via `api.ipify.org` |
| Open SSH | Adds temporary security group rule allowing SSH from runner IP |
| SSH deploy | SSHs to EC2 and runs `~/app/scripts/deploy.sh` |
| Revoke SSH | **Always runs** (even on failure) -- removes the temporary SSH rule |

### Deploy Script

The deploy script on the EC2 instance (`~/app/scripts/deploy.sh`) pulls the new image from ECR and restarts the Docker Compose stack.

### Required GitHub Secrets

| Secret | Description |
|--------|-------------|
| `AWS_ACCESS_KEY_ID` | AWS IAM access key for ECR and EC2 |
| `AWS_SECRET_ACCESS_KEY` | AWS IAM secret key |
| `AWS_REGION` | AWS region (e.g., `us-west-2`) |
| `AWS_ACCOUNT_ID` | AWS account ID for ECR registry URL |
| `EC2_HOST` | EC2 Elastic IP address |
| `EC2_SSH_KEY` | Private SSH key for EC2 access |
| `EC2_SG_ID` | Security group ID for dynamic SSH rule |

---

## SSL Setup

### Initial Certificate

Certificates are obtained from Let's Encrypt using Certbot:

```bash
certbot certonly --webroot \
  -w /var/www/certbot \
  -d game-practice-aws.com
```

### Certificate Files

```
/etc/letsencrypt/live/game-practice-aws.com/
  fullchain.pem   # Certificate chain
  privkey.pem     # Private key
```

### Renewal

Certificates auto-renew via Certbot's systemd timer. Nginx is configured with an ACME challenge exception path (`/.well-known/acme-challenge/`) that serves from the `certbot_webroot` volume.

### HTTP to HTTPS

All HTTP (port 80) requests are redirected to HTTPS (port 443), except for ACME challenge requests needed for certificate renewal.

---

## Deployment Checklist

1. **Terraform:** Run `terraform apply` in `infra/terraform/` to provision EC2, security group, IAM, and SSM parameters
2. **SSH setup:** Upload your SSH key pair and verify EC2 access
3. **OAuth:** Manually set Google OAuth credentials in SSM via AWS Console
4. **SSL:** Run Certbot on the EC2 instance to obtain initial certificates
5. **Docker Compose:** Deploy with `docker-compose -f docker-compose.prod.yml up -d`
6. **GitHub Secrets:** Configure all required secrets in the repository settings
7. **Push to main:** CI/CD pipeline handles subsequent deployments automatically

---

## Architecture Diagram

```
                    Internet
                       |
                   [Nginx:443]
                    /       \
             REST API     WebSocket
            /api/*      /api/socket.io/
                \         /
              [Fastify:3001]
               /          \
       [PostgreSQL:5432]  [Redis:6379]
```

---

**Navigation:** [Home](Home.md) | [Architecture](Architecture.md) | [Socket Events](Socket-Events.md) | [Database Schema](Database-Schema.md) | [API Reference](API-Reference.md) | Deployment
